# TCP/UART同步功能说明

## 功能概述

新增的同步功能允许您控制TCP和UART通信的启动时机，只有在同步成功后，通信通道才会开始正常的数据收发。

## 主要特性

### 1. 同步控制界面
- **同步模式开关**: 启用/禁用同步功能
- **同步字符串配置**: 为TCP和UART分别设置发送和接收的同步字符串
- **同步状态显示**: 实时显示同步状态和进度
- **同步控制按钮**: 开始同步和重置同步

### 2. 同步流程
1. **启用同步模式**: 勾选"启用同步模式"复选框
2. **配置同步字符串**: 设置TCP和UART的发送/接收同步字符串
3. **建立连接**: 连接TCP和/或UART
4. **开始同步**: 点击"开始同步"按钮
5. **等待确认**: 系统发送同步字符串并等待确认
6. **同步完成**: 收到所有确认后开始正常通信

### 3. 同步控制逻辑
- **发送控制**: 在同步完成前，无法发送数据
- **接收控制**: 在同步完成前，只显示同步相关数据
- **超时处理**: 10秒超时机制，防止无限等待
- **状态管理**: 实时显示同步状态和进度

## 使用方法

### 基本使用步骤

1. **启动应用**
   ```bash
   python tcp_uart_unified_app_main_v2.py
   ```

2. **配置同步**
   - 勾选"启用同步模式"
   - 设置TCP同步字符串（发送/接收）
   - 设置UART同步字符串（发送/接收）

3. **建立连接**
   - 连接TCP（客户端或服务端）
   - 连接UART串口

4. **执行同步**
   - 点击"开始同步"按钮
   - 观察同步状态显示
   - 等待同步完成

5. **正常通信**
   - 同步完成后可以正常发送和接收数据
   - 数据转发功能正常工作

### 测试同步功能

运行测试脚本：
```bash
python test_sync_app.py
```

测试脚本会：
- 启动一个测试TCP服务器
- 自动响应同步字符串
- 提供使用说明和测试步骤

## 同步字符串配置

### 默认配置
- **TCP发送**: `SYNC_SEND`
- **TCP接收**: `SYNC_RECV`
- **UART发送**: `SYNC_SEND`
- **UART接收**: `SYNC_RECV`

### 自定义配置
您可以根据需要修改同步字符串：
- 发送字符串：用于发送给远程设备
- 接收字符串：用于识别远程设备的确认

## 状态指示

### 同步状态显示
- **同步未启用**: 灰色文字
- **同步模式已启用**: 橙色文字
- **等待同步确认**: 橙色文字
- **同步完成**: 绿色文字
- **同步超时**: 红色文字

### 数据标签
- `[同步]`: 同步相关数据
- `[同步等待]`: 等待同步确认期间的数据
- `[同步] TCP收到同步确认`: TCP同步确认
- `[同步] UART收到同步确认`: UART同步确认

## 高级功能

### 1. 超时处理
- 默认10秒超时
- 超时后可以重新尝试同步
- 超时状态会显示在界面上

### 2. 多通道同步
- 支持TCP和UART同时同步
- 只有连接的通道需要同步
- 所有连接的通道都收到确认后才开始正常通信

### 3. 状态重置
- 可以随时重置同步状态
- 重置后可以重新开始同步
- 关闭同步模式会自动重置状态

## 故障排除

### 常见问题

1. **同步超时**
   - 检查网络连接
   - 确认同步字符串配置正确
   - 检查远程设备是否响应

2. **无法发送数据**
   - 确认同步已完成
   - 检查连接状态
   - 查看状态显示

3. **数据不显示**
   - 确认同步已完成
   - 检查数据格式
   - 查看同步状态

### 调试建议

1. **启用详细日志**: 观察控制台输出
2. **检查同步字符串**: 确保发送和接收字符串匹配
3. **测试连接**: 先测试基本连接，再测试同步
4. **逐步调试**: 先测试单个通道，再测试多通道

## 技术实现

### 核心组件
- `sync_enabled`: 同步模式开关
- `tcp_sync_received`: TCP同步确认状态
- `uart_sync_received`: UART同步确认状态
- `sync_timer`: 同步超时定时器

### 关键方法
- `on_sync_enable_toggled()`: 同步模式切换
- `start_sync()`: 开始同步过程
- `update_sync_status()`: 更新同步状态
- `sync_timeout()`: 同步超时处理
- `reset_sync()`: 重置同步状态

### 数据流控制
- 发送数据前检查同步状态
- 接收数据时检查同步确认
- 同步完成前阻止正常数据处理

## 更新日志

### v2.0 - 同步功能
- 新增同步控制界面
- 实现同步逻辑控制
- 添加超时处理机制
- 支持多通道同步
- 完善状态管理和显示

---

这个同步功能为您的TCP/UART通信应用提供了更精确的控制能力，确保通信的可靠性和时序性。

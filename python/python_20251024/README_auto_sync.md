# TCP/UART应用 - 自动同步功能

## 功能概述

已成功实现连接时自动同步功能，用户设置好同步信息后，当连接UART或TCP时会自动开始同步过程，无需手动点击同步按钮。

## 🎯 新功能特性

### 自动同步开关
- **连接时自动同步** (绿色开关) - 控制是否在连接时自动开始同步
- **默认开启** - 自动同步功能默认启用
- **灵活控制** - 可以随时开启/关闭自动同步

### 工作流程
```
1. 设置同步字符串 (TCP/UART)
2. 开启'连接时自动同步'开关
3. 连接UART或TCP
4. 自动发送同步字符串
5. 等待同步确认
6. 同步完成后开始正常通信
```

## 🔧 功能特点

### 智能检测
- **连接检测**: TCP/UART连接时自动检查同步设置
- **条件判断**: 同步模式开启 + 自动同步开启
- **状态管理**: 实时跟踪自动同步状态

### 自动发送
- **TCP自动同步**: 根据TCP发送开关状态自动发送同步字符串
- **UART自动同步**: 根据UART发送开关状态自动发送同步字符串
- **开关控制**: 只有开启的发送开关才会发送同步字符串

### 状态显示
- **自动同步状态**: 显示"自动同步中..."状态
- **日志标识**: 自动同步日志带有"[自动同步]"前缀
- **状态反馈**: 清晰的状态指示和反馈

## 🎨 界面优化

### 新增开关
```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 同步控制页面 - 自动同步功能                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ ☑ 启用同步模式                                                              │
│ ☑ 连接时自动同步 (绿色开关)                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ TCP同步字符串:                                                              │
│ ┌─────────────┐ ┌─────────────────────────────────────────────────────┐    │
│ │ 启用发送   │ │ SYNC_SEND (发送的同步字符串)                        │    │
│ │ (红色)     │ │                                                     │    │
│ └─────────────┘ └─────────────────────────────────────────────────────┘    │
│ ┌─────────────┐ ┌─────────────────────────────────────────────────────┐    │
│ │ 启用接收   │ │ SYNC_RECV (接收的同步字符串)                        │    │
│ │ (绿色)     │ │                                                     │    │
│ └─────────────┘ └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 颜色编码
- **自动同步开关**: 绿色，表示自动功能
- **发送开关**: 红色，表示发送功能
- **接收开关**: 绿色，表示接收功能

## 📊 控制逻辑

### 连接检测
```python
def on_uart_connection_changed(self, connected):
    if connected:
        # 如果启用了同步模式和自动同步，自动开始同步
        if self.sync_enabled and self.auto_sync_enabled:
            self.auto_start_sync()
```

### 自动同步方法
```python
def auto_start_sync(self):
    """自动开始同步（连接时自动调用）"""
    if not self.sync_enabled:
        return
    
    # 检查连接状态
    tcp_connected = self.tcp_thread and self.tcp_thread.isRunning()
    uart_connected = self.uart_thread and self.uart_thread.isRunning()
    
    # 自动发送同步字符串
    if tcp_connected and self.sync_page:
        if self.sync_page.tcp_send_enable_check.isChecked():
            tcp_sync_send = self.sync_page.tcp_sync_send_input.text().strip()
            if tcp_sync_send:
                self.tcp_thread.send_data(tcp_sync_send + '\n')
                self.add_tcp_display_text(f"[自动同步] 发送TCP同步字符串: {tcp_sync_send}")
```

### 同步条件
- **同步模式开启**: `self.sync_enabled = True`
- **自动同步开启**: `self.auto_sync_enabled = True`
- **连接状态**: TCP或UART已连接
- **发送开关**: 对应的发送开关已开启

## 🔧 技术实现

### 核心组件
- **auto_start_sync()**: 自动同步方法
- **auto_sync_enabled**: 自动同步状态变量
- **连接事件处理**: 连接时触发自动同步
- **状态管理**: 自动同步状态跟踪

### 事件处理
```python
def on_auto_sync_toggled(self, checked):
    """自动同步开关处理"""
    self.parent_app.auto_sync_enabled = checked
```

### 状态管理
- **自动同步状态**: 实时跟踪自动同步开关状态
- **连接状态**: 监控TCP/UART连接状态
- **同步状态**: 跟踪同步完成状态
- **超时处理**: 10秒同步超时机制

## 📋 使用场景

### 1. 快速连接
- 设置好同步信息后直接连接
- 无需手动点击同步按钮
- 自动开始同步过程

### 2. 批量测试
- 多次连接时自动同步
- 减少重复操作
- 提高测试效率

### 3. 自动化流程
- 减少手动操作步骤
- 简化工作流程
- 提高自动化程度

### 4. 调试方便
- 自动开始同步过程
- 清晰的日志标识
- 便于问题排查

### 5. 灵活控制
- 可以关闭自动同步
- 支持手动同步
- 满足不同需求

## 🚀 优势特性

### 操作简化
- **减少步骤**: 减少手动同步步骤
- **自动化**: 连接时自动开始同步
- **便捷性**: 提高操作便捷性

### 智能检测
- **自动检测**: 自动检测连接和同步设置
- **条件判断**: 智能判断同步条件
- **状态管理**: 实时状态跟踪

### 灵活控制
- **开关控制**: 可以开启/关闭自动同步
- **手动同步**: 支持手动同步模式
- **灵活配置**: 满足不同使用场景

### 状态清晰
- **状态显示**: 明确显示自动同步状态
- **日志标识**: 清晰的日志标识
- **反馈及时**: 及时的状态反馈

### 日志完整
- **详细日志**: 详细的自动同步日志
- **标识清晰**: "[自动同步]"前缀标识
- **便于调试**: 便于问题排查

## 🔍 测试方法

### 测试步骤
1. **进入同步控制页面**
2. **设置TCP和UART同步字符串**
3. **确保'连接时自动同步'开关开启**
4. **进入通信页面**
5. **连接UART或TCP**
6. **观察自动同步过程**
7. **检查日志中的'[自动同步]'信息**

### 测试场景
- **自动同步开启**: 连接时自动开始同步
- **自动同步关闭**: 需要手动点击同步按钮
- **开关控制**: 测试开关的开启/关闭效果
- **日志检查**: 验证日志标识的正确性

## ⚠️ 注意事项

### 使用要求
- **同步设置**: 自动同步需要先设置好同步字符串
- **开关状态**: 同步开关状态影响自动同步行为
- **连接状态**: 需要先建立TCP或UART连接

### 功能限制
- **依赖设置**: 依赖同步字符串的正确设置
- **开关影响**: 发送/接收开关影响自动同步行为
- **超时处理**: 自动同步失败会显示超时信息

### 最佳实践
- **先设置后连接**: 先设置好同步信息再连接
- **检查开关**: 确保相关开关状态正确
- **观察日志**: 通过日志了解同步过程
- **灵活使用**: 根据需要开启/关闭自动同步

## 📈 更新日志

### v2.5 - 自动同步功能
- ✅ 添加连接时自动同步功能
- ✅ 实现自动同步开关控制
- ✅ 优化连接事件处理逻辑
- ✅ 增强状态显示和日志标识
- ✅ 完善用户体验和操作流程

### 主要改进
- **自动化**: 连接时自动开始同步
- **智能控制**: 智能检测同步条件
- **灵活配置**: 可开启/关闭自动同步
- **状态清晰**: 明确的状态显示和反馈
- **日志完整**: 详细的自动同步日志

---

这个自动同步功能为您的TCP/UART应用提供了更智能和便捷的同步控制能力，大大简化了操作流程，提高了使用效率！

# TCP/UART统一通信应用

## 📋 概述

这是一个基于PyQt5开发的TCP和UART通信工具，提供了图形化界面来进行网络通信和串口通信。支持客户端/服务端模式切换、数据转发、实时数据绘图等功能。

## ✨ 主要功能

### 1. TCP通信功能
- **双模式支持**：支持TCP服务端和客户端模式切换
- **连接管理**：可配置IP地址和端口号
- **数据发送**：支持文本数据发送，可选择是否添加换行符
- **快捷发送**：预设快速发送按钮（Hello, Test, Ping, Data）
- **实时显示**：带时间戳的接收数据显示
- **状态指示**：实时显示连接状态

### 2. UART（串口）通信功能
- **串口配置**：自动检测可用串口（ttyUSB*、ttyACM*）
- **参数设置**：支持波特率（1200-115200）和数据位（5-8）配置
- **连接管理**：一键打开/关闭串口
- **数据发送**：支持文本数据发送，可选择是否添加换行符
- **快捷发送**：预设快速发送按钮（Hello, Test, Ping, Data）
- **实时显示**：带时间戳的接收数据显示

### 3. 数据转发功能
- **TCP → UART**：将TCP接收的数据自动转发到UART
- **UART → TCP**：将UART接收的数据自动转发到TCP
- **条件转发**：支持根据指定字符串进行条件转发
- **灵活配置**：可独立启用/禁用各个方向的转发

### 4. 实时数据绘图
- **多通道支持**：最多支持6个数据通道（data1-data6）
- **独立绘图**：TCP和UART各自独立的绘图窗口
- **数据格式**：支持逗号分隔的数值格式（如：`1.0, 2.2, 3.3`）
- **可配置显示点数**：0-50000点可调（默认100点）
- **暂停/恢复**：支持暂停实时更新进行数据分析
- **通道选择**：可动态选择显示哪些数据通道
- **数据导出**：支持将当前显示数据保存为CSV文件
- **清空功能**：一键清空当前绘图数据
- **交互操作**：支持缩放、平移、鼠标滚轮缩放等操作
- **专业显示**：刻度朝内、网格线、图例等专业绘图特性

### 5. 界面特性
- **分栏布局**：TCP和UART并排显示，可拖动调整比例
- **清晰分组**：功能区域分组清晰，易于操作
- **实时反馈**：状态指示和按钮状态实时更新
- **颜色标识**：不同状态使用不同颜色标识
- **响应式设计**：适应不同屏幕尺寸

## 🔧 系统要求

### Python版本
- Python 3.6+

### 依赖库
```bash
# 必需依赖
pip install PyQt5
pip install pyserial
pip install numpy
pip install matplotlib
```

### 操作系统
- Linux（推荐，串口自动检测针对Linux优化）
- Windows（需要手动选择COM端口）
- macOS（需要手动选择串口设备）

## 🚀 快速开始

### 1. 安装依赖
```bash
# 使用pip安装
pip install PyQt5 pyserial numpy matplotlib

# 或使用conda安装
conda install pyqt pyserial numpy matplotlib
```

### 2. 运行应用
```bash
python tcp_uart_unified_app.py
```

### 3. 基本配置
1. **TCP配置**：选择服务端或客户端模式，设置IP和端口
2. **UART配置**：选择串口，设置波特率和数据位
3. 点击"连接"或"打开串口"按钮开始通信

## 📖 详细使用说明

### TCP通信使用

#### 作为服务端
1. 选择模式：**服务端**（默认选项）
2. 设置监听地址：`0.0.0.0`（监听所有网络接口）或特定IP
3. 设置端口：如 `8888`
4. 点击**连接**按钮，等待客户端连接
5. 状态显示："TCP服务端已启动，等待客户端连接..."
6. 客户端连接后显示："客户端已连接"

#### 作为客户端
1. 选择模式：**客户端**
2. 设置目标地址：服务端的IP地址（如 `192.168.1.100`）
3. 设置端口：服务端监听的端口（如 `8888`）
4. 点击**连接**按钮
5. 状态显示："TCP客户端已连接"

#### 发送数据
1. 在"TCP数据发送"区域输入要发送的数据
2. 勾选"发送时添加换行符"（默认勾选）
3. 点击**发送**按钮或按回车键
4. 或使用快捷发送按钮快速发送预设内容

#### 接收数据
- 接收的数据会自动显示在"TCP数据接收"区域
- 每条数据带有时间戳：`[HH:MM:SS] 数据内容`
- 点击**清空TCP显示**可清空接收区域

### UART通信使用

#### 打开串口
1. 选择串口：下拉菜单会自动列出可用串口
   - Linux：`/dev/ttyUSB0`, `/dev/ttyACM0` 等
   - Windows：`COM1`, `COM2` 等
2. 设置波特率：如 `115200`（常用值）
3. 设置数据位：通常为 `8`
4. 点击**打开串口**按钮
5. 状态显示："UART已连接"，按钮变为"关闭串口"

#### 发送数据
1. 在"UART数据发送"区域输入要发送的数据
2. 勾选"发送时添加换行符"（默认勾选）
3. 点击**发送**按钮或按回车键
4. 或使用快捷发送按钮快速发送预设内容

#### 接收数据
- 接收的数据会自动显示在"UART数据接收"区域
- 每条数据带有时间戳：`[HH:MM:SS] 数据内容`
- 点击**清空UART显示**可清空接收区域

### 数据转发使用

#### TCP → UART转发
1. 确保TCP和UART都已连接
2. 在TCP的"数据转发"区域勾选：**TCP接收数据转发到UART**
3. TCP接收到的所有数据会自动通过UART发送出去

#### UART → TCP转发
1. 确保TCP和UART都已连接
2. 在UART的"数据转发"区域勾选：**UART接收数据转发到TCP**
3. UART接收到的所有数据会自动通过TCP发送出去

#### 条件转发
1. 勾选**仅转发包含指定内容**
2. 在文本框中输入要匹配的字符串（如 `DATA`）
3. 只有包含该字符串的数据才会被转发
4. 转发内容仅为指定的字符串加换行符

**示例**：
- 接收数据：`123 DATA 456`
- 指定内容：`DATA`
- 转发内容：`DATA\n`

### 实时绘图使用

#### 启用绘图
1. 勾选"TCP实时绘图"或"UART实时绘图"组框（默认已勾选）
2. 取消勾选会停止数据更新，但保留绘图界面

#### 数据格式
发送的数据应为逗号分隔的数值格式：
```
1.0, 2.2, 3.3
4.5, 6.7, 8.9
...
```

每行数据代表一个时间点，每个数值代表一个通道的数据。

#### 调整显示点数
1. 在"显示点数"输入框中输入数值（范围：0-50000）
2. 默认值：100点
3. 0表示显示所有点
4. 数值越大，可以看到更多历史数据

#### 暂停/恢复绘图
1. 点击**暂停**按钮可暂停实时更新
2. 按钮变为"恢复"，再次点击继续更新
3. 暂停时可以使用工具栏进行缩放、平移等操作

#### 选择显示通道
1. 使用"显示通道"区域的复选框选择要显示的通道
2. 默认显示所有通道（data1-data6）
3. 取消勾选某个通道，该通道的数据线会消失
4. 重新勾选可恢复显示

#### 保存数据
1. 暂停绘图（可选）
2. 点击**保存CSV**按钮
3. 选择保存位置和文件名
4. 数据以CSV格式保存，列名为data1, data2, ...

#### 清空绘图
1. 点击**清空**按钮
2. 清除当前所有绘图数据
3. 绘图从零开始重新记录

#### 绘图操作
- **缩放**：工具栏的放大镜图标或鼠标滚轮
- **平移**：工具栏的十字箭头图标
- **还原**：工具栏的Home图标
- **后退/前进**：工具栏的左右箭头
- **保存图片**：工具栏的软盘图标

## 🎯 使用场景示例

### 场景1：串口数据采集和可视化
1. 连接UART设备（如Arduino、传感器模块）
2. 打开串口，设置正确的波特率
3. 启用UART实时绘图
4. 设备发送传感器数据：`25.5, 60.3, 1013.25`（温度、湿度、气压）
5. 实时查看数据曲线变化
6. 暂停后保存数据到CSV进行后续分析

### 场景2：TCP/UART网关
1. 打开UART串口连接本地设备
2. 配置TCP服务端，监听网络请求
3. 启用双向转发：
   - UART → TCP：将串口数据发送到网络
   - TCP → UART：将网络命令转发到串口设备
4. 实现远程控制和数据采集

### 场景3：协议测试
1. 配置TCP客户端连接到测试服务器
2. 使用快捷发送按钮或自定义命令发送测试数据
3. 实时查看服务器响应
4. 使用条件转发功能过滤特定响应
5. 通过绘图观察数据流特征

### 场景4：双通道数据对比
1. 同时连接TCP和UART数据源
2. 启用两个独立的实时绘图
3. 并排对比两个数据源的特征
4. 分析数据同步性、延迟等特性

## ⚙️ 高级配置

### 修改快捷发送按钮
在代码中找到以下部分并修改：
```python
tcp_quick_buttons = ["Hello", "Test", "Ping", "Data"]
uart_quick_buttons = ["Hello", "Test", "Ping", "Data"]
```

### 调整窗口大小
修改 `init_ui()` 中的窗口大小设置：
```python
self.setGeometry(100, 100, 1600, 800*2)  # x, y, width, height
```

### 自定义绘图样式
在 `RealTimePlotWidget` 类中修改：
```python
# 线条颜色
colors = ['b', 'g', 'r', 'c', 'm', 'y']  # 蓝、绿、红、青、品红、黄

# 字体大小
self.ax.tick_params(axis='both', labelsize=16, direction='in')

# 线条宽度
self.ax.plot(x_data, y_data, color, label=f'data{i+1}', linewidth=3)
```

### 修改数据解析格式
如果数据格式不是逗号分隔，可以在 `RealTimePlotWidget.add_data()` 中修改：
```python
# 当前：逗号分隔
values = [float(v.strip()) for v in line.split(',') if v.strip()]

# 修改为空格分隔
values = [float(v.strip()) for v in line.split() if v.strip()]

# 修改为制表符分隔
values = [float(v.strip()) for v in line.split('\t') if v.strip()]
```

## 🐛 常见问题

### 1. 串口无法打开
**问题**：点击"打开串口"后没有反应或报错
**解决**：
- 检查串口是否已被其他程序占用
- Linux用户确认有串口访问权限：`sudo usermod -a -G dialout $USER`
- 重新拔插USB串口设备
- 检查设备是否需要特定的驱动程序

### 2. TCP连接失败
**问题**：TCP客户端无法连接到服务端
**解决**：
- 确认服务端已启动并在监听
- 检查IP地址和端口号是否正确
- 检查防火墙设置
- 服务端使用 `0.0.0.0` 监听所有接口，客户端使用实际IP连接

### 3. 绘图不显示数据
**问题**：接收到数据但绘图没有更新
**解决**：
- 确认"实时绘图"组框已勾选
- 检查数据格式是否正确（逗号分隔的数值）
- 查看终端是否有解析错误信息
- 确认没有点击"暂停"按钮

### 4. 数据显示乱码
**问题**：接收数据显示为乱码或特殊字符
**解决**：
- UART：检查波特率设置是否与设备匹配
- TCP：确认数据编码格式（默认UTF-8）
- 检查数据位、停止位、校验位设置

### 5. 应用卡顿或崩溃
**问题**：数据量大时应用响应缓慢
**解决**：
- 减小显示点数（如设置为100-1000）
- 暂停不需要的绘图功能
- 定期清空接收显示区域
- 关闭不使用的转发功能

### 6. 绘图数据与接收数据不匹配
**问题**：TCP接收显示的数据与绘图数据不一致
**解决**：
- TCP是流式协议，数据可能分包到达，已通过缓冲区处理
- 确保发送的数据以换行符结尾
- 检查是否有多余的空格或特殊字符

### 7. 断开连接时程序卡住
**问题**：点击"断开"后程序无响应
**解决**：
- 已通过socket超时机制解决
- 如果仍然出现，强制关闭程序重启
- 检查防火墙或网络设置

## 📊 性能参数

### 通信性能
- **TCP吞吐量**：取决于网络带宽
- **UART波特率**：1200-115200 bps
- **数据刷新率**：约100ms（绘图更新间隔）
- **最大缓冲点数**：50000点

### 资源占用
- **内存**：约50-100MB（取决于缓冲数据量）
- **CPU**：空闲时<5%，数据更新时10-20%
- **线程**：主线程 + TCP线程 + UART线程

## 🔐 安全提示

1. **网络安全**：
   - 不要在公网上直接暴露TCP服务端
   - 使用防火墙限制访问IP
   - 考虑添加身份验证机制

2. **数据安全**：
   - 敏感数据传输考虑加密
   - 不要在生产环境使用明文传输密码

3. **设备安全**：
   - 确认串口设备的电气特性匹配
   - 使用隔离器保护主机

## 📝 更新日志

### v1.0 (当前版本)
- ✅ TCP客户端/服务端通信
- ✅ UART串口通信
- ✅ 双向数据转发
- ✅ 条件转发功能
- ✅ 实时数据绘图（最多6通道）
- ✅ 可配置显示点数（0-50000）
- ✅ 暂停/恢复绘图
- ✅ 通道选择显示
- ✅ CSV数据导出
- ✅ 专业绘图样式（刻度朝内、网格线等）
- ✅ 鼠标滚轮缩放
- ✅ 导航工具栏
- ✅ TCP流式数据缓冲处理
- ✅ 优雅的连接断开处理

## 🤝 贡献

欢迎提交问题报告和功能建议！

## 📄 许可证

本项目仅供学习和研究使用。

## 📧 联系方式

如有问题或建议，请通过以下方式联系：
- 项目地址：/home/xwj/0-code/0-github/motor/python/
- 文档位置：README_tcp_uart_app.md

---

**祝您使用愉快！** 🎉

